<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Pratique Figures</title>

    <script src="https://unpkg.com/mathjs@6.5.0/dist/math.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML.js"></script>
    <script src="https://memoquiz.github.io/algebrite.bundle-for-browser.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/3.0.13/svg.js"></script>

    <style>
        h1 {
            text-align: center;
        }

        h2 {
            text-align: center;
        }

        canvas {
            padding-left: 0;
            padding-right: 0;
            margin-left: auto;
            margin-right: auto;
            display: block;
        }

        .button1 {
            font-family: arial;
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 5px 5px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 20px;
            margin: 2px 2px;
            cursor: pointer;
            width: 20%;
        }

        .button2 {
            font-family: arial;
            background-color: rgb(46, 51, 47);
            border: none;
            color: white;
            padding: 5px 5px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 20px;
            margin: 2px 2px;
            cursor: pointer;
            width: 10%;
        }

        input {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            text-align: center;
        }

        input[type="file"] {
            display: none;
        }
    </style>
</head>

<body>

    <h1>
        Quelle est le rapport de similitude entre ces deux figures ?
    </h1>
    <h2>
        <table align=center>
            <tr>
                <td>
                    <div id="pretty">$$$$</div>
                </td>
            </tr>
            <tr>
                <td><input type="text" id="reponse" /></td>
            </tr>
            <tr>
                <td style="min-width:1000px"><input type="button" class="button0" value="Soumettre" id="bouttonSoum"
                        onclick="setTimeout(function(){soum()},100)">
                </td>
            </tr>
        </table>
        <br>Progression : <output id="reussi"></output> / <output id="total"></output>
        <br>Erreurs : <output id="erreurs"></output>
        <br><br>Sélectionne le niveau de difficulté<br>
        <td style="min-width:200px"><input type="button" class="button2" value="Doux" id="button0" onclick="diff(0)">
        <td style="min-width:200px"><input type="button" class="button2" value="Medium" id="button1" onclick="diff(1)">
        <td style="min-width:200px"><input type="button" class="button2" value="Piquant" id="button2" onclick="diff(2)">
    </h2>
    <script>
        middlePoint = function(p1,p2){
            return Math.min(p1,p2)+Math.abs(p1-p2)/2
        }

        length = function(p1,p2){
            return Math.sqrt(Math.pow(p1[0]-p2[0],2)+Math.pow(p1[0]-p2[0],2))
        }

        segments = function (points) {
                var midPoints = []
                var lengthSeg = []
                for (i = 0; i < points.length; i++) {
                    var p1 = points[i % ncote]
                    var p2 = points[(i + 1) % ncote]
                    midPoints[i] = [middlePoint(p1[0],p2[0]), middlePoint(p1[1], p2[1])]
                    lengthSeg[i] = length(p1,p2)
                }
                return [midPoints,lengthSeg]
            }

            function drawPolygons (numberOfSides, size, randFactor,k) {
                var points = []
                var pointsIma = []
                console.log(k)
                for (var i = 1; i <= numberOfSides; i += 1) {
                    var randx = randFactor * (Math.random() - 0.5)
                    var randy = randFactor * (Math.random() - 0.5)
                    var xval = Math.cos(i * 2 * Math.PI / numberOfSides)
                    var yval = Math.sin(i * 2 * Math.PI / numberOfSides)
                    points[i - 1] = [150 + size * xval + randx,150 + size * yval + randy]
                    pointsIma[i - 1] = [150 + size * k * xval + randx*k,150 + size * k * yval + randy * k]

                }
                console.log(pointsIma)
                drawFig(points, draw)
                drawFig(pointsIma, draw1)
            }

            function drawFig(points, draw) {
                    var polygon = draw.polygon(points)
                    polygon.fill('none').stroke({ color: '#000', width: 4, linecap: 'round', linejoin: 'round' })
                    var seg = segments(points)
                    var middPoints = seg[0]
                    var lengthSeg = seg[1]
                    for (var i = 0; i < lengthSeg.length; i++) {
                        var x = middPoints[i][0] - 150
                        var y = -(middPoints[i][1] - 150)
                        var angle = Math.atan2(y, x)
                        var text = draw.text(lengthSeg[i].toFixed(0), toString()).font({
                            family: 'Helvetica'
                            , size: font
                        })
                        //  draw.circle(10).center(middPoints[i][0] + 1.5 * w * Math.cos(angle), middPoints[i][1] - font * Math.sin(angle))
                        var w = text.bbox().width
                        text.center(middPoints[i][0] + 1.5 * w * Math.cos(angle), middPoints[i][1] - font * Math.sin(angle))
                    }
                }


        function diff(val) {
            difficulte = val
            if (val == 2) {
                eq = ["var1(x+var2)-(var5x+var4)÷var3", "var1(x+var2)-(var5x+var4)/var3", "var1(x+var2x)-(var5x+var4x)/var3"]
                nouvelleQ()
            } else if (val == 1) {
                eq = ["var1(x+var2)", "var1(var2x+var3)", "(var1x+var2)÷var3", "(var1x+var2)/var3"]
                nouvelleQ()
            } else {
                eq = ["var1(x+var2)", "var1(var2x+var3)"]
                nouvelleQ()
            }
        }

        function nouvelleQ() {
            var qi = Math.floor(Math.random() * eq.length)
            q = eq[qi]
            var min = -9
            var max = 9
            var var1 = replaceZero(Math.floor(Math.random() * (max - min)) + min)
            var var2 = replaceZero(Math.floor(Math.random() * (max - min)) + min)
            var var3 = replaceZero(Math.floor(Math.random() * (max - min)) + min)
            var var4 = replaceZero(Math.floor(Math.random() * (max - min)) + min)
            var var5 = replaceZero(Math.floor(Math.random() * (max - min)) + min)
            var var6 = replaceZero(Math.floor(Math.random() * (max - min)) + min)
            q = q.replace(/var1/g, var1);
            q = q.replace(/var2/g, var2);
            q = q.replace(/var3/g, var3)
            q = q.replace(/var4/g, var4);
            q = q.replace(/var5/g, var5);
            q = q.replace(/var6/g, var6)
            q = q.replace(/\+\-/g, '-');

            expr.value = q
            q = q.replace(/÷/g, '/');
            if (var3 < 0 && difficulte == 1 && qi > 1) {
                q = q.replace(/\/\-/g, '/(-').concat(')');
            } else if (var3 < 0 && difficulte == 2) {
                q = q.replace(/\/\-/g, '/(-').concat(')');
            }
            var reponse = Algebrite.run(q)
            //console.log(reponse)
            update()
        }

        function replaceZero(val) {
            if (val <= 0) {
                val = val - 1;
            }
            if (val == 1) {
                val = val + 1;
            }
            return val;
        }
        soum = function () {
            var repEleve = document.getElementById('reponse').value.toString()
            repEleve = repEleve.replace(/\,/, '.') // Remplace les , par des . pour les eleves francophones
            document.getElementById('reponse').value = null
            try {
                // Teste si l'expression de l'élève correspond à la réponse en s'assurant que la différence entre les deux si évalué 
                // a x=3 est de moins de 0.1
                var brep = expr.value.replace(/÷/g, '/');
                var succes1 = math.abs(math.parse(repEleve).evaluate({ x: 3 }) - math.parse(brep).evaluate({ x: 3 })) < 0.1
                var succes2 = math.abs(math.parse(repEleve).evaluate({ x: -3 }) - math.parse(brep).evaluate({ x: -3 })) < 0.1
            } catch{
                var succes1 = false
                var succes2 = false
            }

            nbEssais++

            if (succes1 == true && succes2 == true) {
                reussi++
                if (reussi < total) {
                    nouvelleQ()
                    button.style.backgroundColor = "#4CAF50"
                    button.value = "Soumettre"

                } else {
                    if (reussi / total > 0.8) {
                        expr.value = 'Bravo!'
                    } else {
                        expr.value = 'Tu as besoin de plus de pratique on dirait'
                    }
                    button.value = "Recommencer ?"
                    button.onclick = recommancer
                    update()
                }
            } else {
                button.style.backgroundColor = "red"
                button.value = "Réessaie !"
                erreurs++
                update()
            }
        }

        recommancer = function () {
            total = 0
            reussi = 0
            erreurs = 0
        }

        update = function () {
            document.getElementById('reussi').value = reussi
            document.getElementById('erreurs').value = erreurs
            document.getElementById('total').value = total
            let node = null
            node = math.parse(expr.value)

            try {
                // export the expression to LaTeX
                const latex = node ? node.toTex({ parenthesis: parenthesis, implicit: implicit }) : ''

                // display and re-render the expression
                const elem = MathJax.Hub.getAllJax('pretty')[0]
                MathJax.Hub.Queue(['Text', elem, latex])
            }
            catch (err) { }
        }

        var total = 10
        var erreurs = 0
        var reussi = 0
        var nbEssais = 0
        var eq = null

        document.getElementById('reussi').value = reussi
        document.getElementById('erreurs').value = erreurs
        document.getElementById('total').value = total

        button = document.getElementById('button3')

        const expr = []
        const pretty = document.getElementById('pretty')
        const result = []
        let parenthesis = 'keep'
        let implicit = 'hide'
        var difficulte = 0
        diff(difficulte)

        // initialize with an example expression
        pretty.innerHTML = '$$' + math.parse(expr.value).toTex({ parenthesis: parenthesis }) + '$$'     
        var draw = SVG().addTo('h1').size(300, 300)
        var draw1 = SVG().addTo('h1').size(300, 300)

        var ncote = 4
        var font = 20
        var k = (Math.random()-0.5)*
        console.log(k)
        drawPolygons(ncote,100,50,k)

    </script>

</body>

</html>