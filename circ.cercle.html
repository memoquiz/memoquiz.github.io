<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Pratique Figures</title>

    <script src="https://unpkg.com/mathjs@6.5.0/dist/math.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML.js"></script>
    <script src="https://memoquiz.github.io/algebrite.bundle-for-browser.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/3.0.13/svg.js"></script>

    <style>
        h1 {
            text-align: center;
        }

        h2 {
            text-align: center;
        }

        h3 {
            text-align: center;
        }

        svg {
            display: block;
            margin: auto;
        }

        canvas {
            padding-left: 0;
            padding-right: 0;
            margin-left: auto;
            margin-right: auto;
            display: block;
        }

        .button1 {
            font-family: arial;
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 5px 5px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 20px;
            margin: 2px 2px;
            cursor: pointer;
            width: 20%;
        }

        .button2 {
            font-family: arial;
            background-color: rgb(46, 51, 47);
            border: none;
            color: white;
            padding: 5px 5px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 20px;
            margin: 2px 2px;
            cursor: pointer;
            width: 10%;
        }

        input {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            text-align: center;
        }

        input[type="file"] {
            display: none;
        }
    </style>
</head>

<body>

    <h1 id='h1'>
    </h1>
    <svg id='canvas' align=center width=600 height=400>
        <marker id="arrowhead" markerWidth="5" markerHeight="3.5" refX="0" refY="3.5" orient="auto">
            <polygon points="0 0, 5 1.75, 0 3.5" />
        </marker>
    </svg>

    <h2>
        <table align=center>
            <tr>
                <td><input type="text" id="reponse" /></td>
            </tr>
            <tr>
                <td style="min-width:1000px"><input type="button" class="button1" value="Soumettre" id="bouttonSoum"
                        onclick="setTimeout(function(){soum()},100)">
                </td>
            </tr>
        </table>
        <br>Progression : <output id="reussi"></output> / <output id="total"></output>
        <br>Erreurs : <output id="erreurs"></output>
        <br><br>Sélectionne le niveau de difficulté<br>
        <td style="min-width:200px"><input type="button" class="button2" value="Doux" id="button0" onclick="diff(0)">
        <td style="min-width:200px"><input type="button" class="button2" value="Medium" id="button1" onclick="diff(1)">
        <td style="min-width:200px"><input type="button" class="button2" value="Piquant" id="button2" onclick="diff(2)">
</h2>
    </h2>
    <script>

function diff(val){
            difficulte = val
            if(val == 2){
                ndiff = ["var1(var2 + var3x)","var1(var2x + var3)","var1(x+var2)-(var5x)"]
                document.getElementById('button2').style.backgroundColor = "grey"
                document.getElementById('button0').style.backgroundColor = "black"
                document.getElementById('button1').style.backgroundColor = "black"
                nouvelleQ()
            } else if (val == 1){
                ndiff = ["var1x", "var1x + var2"]
               
                document.getElementById('button1').style.backgroundColor = "grey"
                document.getElementById('button0').style.backgroundColor = "black"
                document.getElementById('button2').style.backgroundColor = "black"
                nouvelleQ()
            } else {
                ndiff = ["var1"]
               
                document.getElementById('button0').style.backgroundColor = "grey"
                document.getElementById('button2').style.backgroundColor = "black"
                document.getElementById('button1').style.backgroundColor = "black"
                nouvelleQ()
            }
        }

        update = function () {
            document.getElementById('reussi').value = reussi
            document.getElementById('erreurs').value = erreurs
            document.getElementById('total').value = total
        }

        soum = function () {
            var repEleve = document.getElementById('reponse').value
            repEleve = repEleve.replace(/\,/, '.') // Remplace les , par des . pour les eleves francophones
            repEleve = repEleve.replace(letter, 'x') 
            document.getElementById('reponse').value = null
            try {
                // Teste si l'expression de l'élève correspond à la réponse en s'assurant que la différence entre les deux si évalué 
                // a x=3 est de moins de 0.1
                
                var succes1 = math.abs(math.parse(repEleve).evaluate({ x: 3 }) - math.parse(brep).evaluate({ x: 3 })) < 0.1
                var succes2 = math.abs(math.parse(repEleve).evaluate({ x: -3 }) - math.parse(brep).evaluate({ x: -3 })) < 0.1
            } catch{
                var succes1 = false
                var succes2 = false
            }

            nbEssais++

            if (succes1 == true && succes2 == true) {
                reussi++
                if (reussi < total) {
                    nouvelleQ()
                    button.style.backgroundColor = "#4CAF50"
                    button.value = "Soumettre"
                    update()

                } else {
                    draw.clear()
                    if (erreurs / total < 0.8) {
                        draw.text('Bravo!').font({ family: 'serif', size: 50 }).center(300, 150)
                    } else {
                        draw.text('Tu as besoin de plus de pratique on dirait').font({ family: 'serif', size: 20 }).center(300, 150)
                    }
                    button.value = "Recommencer ?"
                    button.onclick = recommancer
                    update()
                }
            } else {
                button.style.backgroundColor = "red"
                button.value = "Réessaie !"
                erreurs++
                update()
            }
        }

        recommancer = function () {
            reussi = 0
            erreurs = 0
            nouvelleQ()
        }

        function nouvelleQ() {
                draw.clear()

                var min = 1
                var max = 99
                var var1 = replaceZero(Math.floor(Math.random() * (max - min)) + min)
                var var2 = replaceZero(Math.floor(Math.random() * (max - min)) + min)
                var var3 = replaceZero(Math.floor(Math.random() * (max - min)) + min)
                var var4 = replaceZero(Math.floor(Math.random() * (max - min)) + min)
                var var5 = replaceZero(Math.floor(Math.random() * (max - min)) + min)


                var letters = "abcdefghkmnopqrstuvwxyz"
                //var unit = ['mm','cm','m','dm','hm','km'][Math.floor(Math.random()*5)]
                var unit = ''

                var ranLett = Math.floor(Math.random() * (letters.length - 1)) + 1
                letter = letters.substring(ranLett - 1, ranLett)

                var qi = Math.floor(Math.random() * ndiff.length)
                var q = ndiff[qi]
                q = q.replace(/var1/g, var1)
                q = q.replace(/var2/g, var2)
                q = q.replace(/var3/g, var3)
                q = q.replace(/var4/g, var2)
                q = q.replace(/var5/g, var3)

                var qLetter = q.replace(/x/g, letter).concat(unit)
                
                draw.circle(360).fill('none').stroke({ color: '#000', width: 4, linecap: 'round', linejoin: 'round' }).center(300, 200)

                var txtH1 = Math.round(Math.random())
                var rayDiam = Math.round(Math.random())
                
                if(txtH1 == 0 && rayDiam == 0){

                    txtH1 = "Quelle est la circonférence de ce cercle ?"
                    var rep = "(".concat(q.concat(')*3.1415926'))

                    draw.path(d = "M 120 200 L 480 200 ").fill('none').stroke({ color: '#000', width: 3, linecap: 'round', linejoin: 'round' })
                    var text = draw.text('d = '.concat(qLetter.toString())).font({ family: 'sans', size: font }).center(300, 220)

                }else if(txtH1 == 0 && rayDiam == 1){

                    txtH1 = "Quelle est la circonférence de ce cercle ?"
                    var rep = "(".concat(q.concat(')*2*3.1415926'))

                    draw.path(d = "M 300 200 L 480 200 ").fill('none').stroke({ color: '#000', width: 3, linecap: 'round', linejoin: 'round' })
                    var text = draw.text('r = '.concat(qLetter.toString())).font({ family: 'sans', size: font }).center(390, 180)

                }else if(txtH1 == 1 && rayDiam == 0){

                    txtH1 = "Quelle est le diamètre de ce cercle ?"
                    var rep = "(".concat(q.concat(')/3.1415926'))
                    draw.path(d = "M 120 200 L 480 200 ").fill('none').stroke({ color: '#000', width: 3, linecap: 'round', linejoin: 'round' })
                    var text = draw.text('C = '.concat(qLetter).toString()).font({ family: 'sans', size: font }).center(300, 150)

                }else if(txtH1 == 1 && rayDiam == 1){
                    txtH1 = "Quelle est le rayon de ce cercle ?"
                    var rep = "(".concat(q.concat(')/2/3.1415926'))
                    draw.path(d = "M 300 200 L 480 200 ").fill('none').stroke({ color: '#000', width: 3, linecap: 'round', linejoin: 'round' })
                    var text = draw.text('C = '.concat(qLetter).toString()).font({ family: 'sans', size: font }).center(300, 150)


                }

                h1 = document.getElementById('h1').innerHTML = txtH1

                brep = Algebrite.run(rep).replace(/\.\.\./g,"")
                console.log(brep)

            }

        function replaceZero(val) {
            if (val <= 0) {
                val = val - 1;
            }
            if (val == 1) {
                val = val + 1;
            }
            return val;
        }

        update = function () {
            document.getElementById('reussi').value = reussi
            document.getElementById('erreurs').value = erreurs
            document.getElementById('total').value = total
        }

        var total = 10
        var erreurs = 0
        var reussi = 0
        var nbEssais = 0

        var brep = null
        var font = 18
        var letter = null
        var ndiff = null
        var txtH1 = null
        var h1 = null
        
        document.getElementById('reussi').value = reussi
        document.getElementById('erreurs').value = erreurs
        document.getElementById('total').value = total

        var button = document.getElementById('bouttonSoum')

        var draw = SVG().addTo('svg')
   
        diff(0)
        nouvelleQ()

    </script>

</body>

</html> 